---
title: Zstack 的小技巧 Tricks For Zigbee
url: 975.html
id: 975
categories:
  - 未分类
tags:
---

前
-

一顿毫无目的的挣扎和尝试，由于项目需要，要开始接触新东西。这里记录一些关于 cc2530 芯片跑 zstack 的一些操作和技巧。

切换频道以及PIN
---------

这里是对Zigbee的信号频道进行设置，以及对连接的Pin码进行配置。修改`f8wconfig.cfg` 目录结构如下 ![file](https://i.loli.net/2019/05/14/5cda97dc5cfc233964.png) 需要去修改这些配置宏。，修改内容如下

    /* Default channel is Channel 11 - 0x0B */
    // Channels are defined in the following:
    //         0      : 868 MHz     0x00000001
    //         1 - 10 : 915 MHz     0x000007FE
    //        11 - 26 : 2.4 GHz     0x07FFF800
    //
    //-DMAX_CHANNELS_868MHZ     0x00000001
    //-DMAX_CHANNELS_915MHZ     0x000007FE
    //-DMAX_CHANNELS_24GHZ      0x07FFF800
    //-DDEFAULT_CHANLIST=0x04000000  // 26 - 0x1A
    //-DDEFAULT_CHANLIST=0x02000000  // 25 - 0x19
    //-DDEFAULT_CHANLIST=0x01000000  // 24 - 0x18
    //-DDEFAULT_CHANLIST=0x00800000  // 23 - 0x17
    //-DDEFAULT_CHANLIST=0x00400000  // 22 - 0x16
    //-DDEFAULT_CHANLIST=0x00200000  // 21 - 0x15
    //-DDEFAULT_CHANLIST=0x00100000  // 20 - 0x14
    //-DDEFAULT_CHANLIST=0x00080000  // 19 - 0x13
    //-DDEFAULT_CHANLIST=0x00040000  // 18 - 0x12
    -DDEFAULT_CHANLIST=0x00020000  // 17 - 0x11
    //-DDEFAULT_CHANLIST=0x00010000  // 16 - 0x10
    //-DDEFAULT_CHANLIST=0x00008000  // 15 - 0x0F
    //-DDEFAULT_CHANLIST=0x00004000  // 14 - 0x0E
    //-DDEFAULT_CHANLIST=0x00002000  // 13 - 0x0D
    //-DDEFAULT_CHANLIST=0x00001000  // 12 - 0x0C
    //-DDEFAULT_CHANLIST=0x00000800  // 11 - 0x0B
    
    /* Define the default PAN ID.
     *
     * Setting this to a value other than 0xFFFF causes
     * ZDO_COORD to use this value as its PAN ID and
     * Routers and end devices to join PAN with this ID
     */
    -DZDAPP_CONFIG_PAN_ID=0x2333

数据处理的过程（函数）
-----------

这里直接从应用层面下手。下面给给出的函数，就是Zstack 的核心代码，这里面

    uint16 SampleApp_ProcessEvent( uint8 task_id, uint16 events )
    {
      afIncomingMSGPacket_t *MSGpkt;
      (void)task_id;  // Intentionally unreferenced parameter
    
      if ( events &amp; SYS_EVENT_MSG )
      {
        MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SampleApp_TaskID );
        while ( MSGpkt )
        {
          switch ( MSGpkt-&gt;hdr.event )
          {
            //case CMD_SERIAL_MSG:  //串口收到数据后由MT_UART层传递过来的数据，用网蜂方法接收，编译时不定义MT相关内容 
             //SampleApp_SerialCMD((mtOSALSerialData_t *)MSGpkt);
            // break;
    
            // Received when a key is pressed
              case KEY_CHANGE:
              SampleApp_HandleKeys( ((keyChange_t *)MSGpkt)-&gt;state, ((keyChange_t *)MSGpkt)-&gt;keys );
              break;
    
            // Received when a messages is received (OTA) for this endpoint
            case AF_INCOMING_MSG_CMD:
              SampleApp_MessageMSGCB( MSGpkt );
              break;
    
            // Received whenever the device changes state in the network
            case ZDO_STATE_CHANGE:
              SampleApp_NwkState = (devStates_t)(MSGpkt-&gt;hdr.status);
              if ( (SampleApp_NwkState == DEV_ZB_COORD) || 
                 (SampleApp_NwkState == DEV_ROUTER)
                  || (SampleApp_NwkState == DEV_END_DEVICE) )
              {
                SerialApp_DeviceConnect();//上传终端的短地址
                // Start sending the periodic message in a regular interval.
                osal_start_timerEx( SampleApp_TaskID,
                                  SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
                                  SAMPLEAPP_SEND_PERIODIC_MSG_TIMEOUT );
              }
              else
              {
                // Device is no longer in the network
              }
              break;
    
            default:
              break;
          }
    
          // Release the memory
          osal_msg_deallocate( (uint8 *)MSGpkt );
          // Next - if one is available
          MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( SampleApp_TaskID );
        }
    
        // return unprocessed events
        return (events ^ SYS_EVENT_MSG);
      }
    
      // Send a message out - This event is generated by a timer
      //  (setup in SampleApp_Init()).
      if ( events &amp; SAMPLEAPP_SEND_PERIODIC_MSG_EVT )
      {
        // Send the periodic message
         SampleApp_SendPointToPointMessage();//点播函数
        // Setup to send message again in normal period (+ a little jitter)
        osal_start_timerEx( SampleApp_TaskID, SAMPLEAPP_SEND_PERIODIC_MSG_EVT,
            10000 );
    
        // return unprocessed events
        return (events ^ SAMPLEAPP_SEND_PERIODIC_MSG_EVT);
      }
    
      // Discard unknown events
      return 0;
    }
    

从HAL拿回中断
--------

修改文件 

    /* Set to TRUE enable KEY usage, FALSE disable it */
    #ifndef HAL_KEY
    #define HAL_KEY FALSE
    #endif